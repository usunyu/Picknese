<!-- @current_user -->

{% extends "picknese/base.html" %}

{% load static %}

{% block title %}
Me |
{% endblock %}

{% block jumbotron %}
<div class="jumbotron profile-jumbotron box-shadow no-bottom-margin" >
    <div class="container" >
        <div class="media">
            <div class="media-left no-left-padding col-xs-12 col-sm-4 col-md-3">
                <div class="show-image">
                    <img
                        class="media-object profile-picture img-thumbnail"
                        src="{% get_media_prefix %}{{current_user.profile.get_avatar}}" />
                        <button
                            type="button"
                            class="btn btn-default btn-lg btn-on-image"
                            data-toggle="modal"
                            data-target="#image-upload-modal">
                            <i class="glyphicon glyphicon-camera"></i> Change Photo
                        </button>
                    </div>
                    
                    <div
                        id="image-upload-modal"
                        class="modal fade"
                        tabIndex="-1"
                        role="dialog"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header background-color-primary">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true" class="color-white">&times;</span>
                                    </button>
                                    <h4 class="modal-title color-white">Change Profile Photo</h4>
                                </div>
                                <div class="modal-body">
                                    <div id="image-upload-input">
                                        <img
                                            class="media-object box-shadow profile-picture"
                                            src="{% get_media_prefix %}{{current_user.profile.get_avatar}}" />
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                    <span class="btn btn-default btn-file">
                                        Browse
                                        <input
                                            type="file" id="image-upload-file" 
                                            onclick="onClickUploadImage(event)"
                                            onchange="onChangeUploadImage(event)" />
                                    </span>
                                    <button
                                        type="button"
                                        class="btn btn-primary" 
                                        onclick="onSubmitUploadImage(event)" >
                                        Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="media-body col-sm-8 col-md-9 profile-info">
                <h3 class="media-heading color-white">
                    {{current_user.first_name}} {{current_user.last_name}}
                </h3>
                <div class="col-md-12 color-white profile-info-div">
                    <div class="col-md-12 profile-info-div">
                        <span class="glyphicon glyphicon-home"></span> {{current_user.profile.university}}
                    </div>
                    <div class="col-md-6 profile-info-div">
                        <span class="glyphicon glyphicon-phone"></span> {{current_user.profile.phone}}
                    </div>
                    <div class="col-md-6 profile-info-div">
                        <span class="glyphicon glyphicon-envelope"></span> {{current_user.profile.wechat}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <ul class="nav nav-tabs nav-justified">
            <li role="presentation"><a href="#"><span class="glyphicon glyphicon-envelope"></span> Inbox <span class="badge">7</span></a></li>
            <li role="presentation" class="active"><a href="#"><span class="glyphicon glyphicon-list-alt"></span> Your Requests <span class="badge">2</span></a></li>
            <li role="presentation"><a href="#"><span class="glyphicon glyphicon-heart"></span> Your Offers <span class="badge">3</span></a></li>
            <li role="presentation"><a href="#"><span class="glyphicon glyphicon-calendar"></span> Calendar</a></li>
            <li role="presentation"><a href="#"><span class="glyphicon glyphicon-picture"></span> Your Photos</a></li>
            <li role="presentation"><a href="#"><span class="glyphicon glyphicon-cog"></span> Account Settings</a></li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_end %}
<script type="text/javascript"> 
var imageUploadCode = null;

function onClickUploadImage(event) {
    $( "#image-upload-file" ).val(null);
}

function onChangeUploadImage(event) {
    event.stopPropagation();
    event.preventDefault();
    var file = event.dataTransfer !== undefined ? event.dataTransfer.files[0] : event.target.files[0];
    var reader = new FileReader();
    reader.onload = (function(theFile) {
        return function(e) {
            var image = new Image();
            image.src = e.target.result;
            image.onload = function() {
                var canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = image.height * (300 / image.width);
                var ctx = canvas.getContext('2d');
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

                $('#image-upload-input')
                    .html(['<img class="media-object box-shadow" src="', canvas.toDataURL(), '"/>'].join(''));

                var img = $('#image-upload-input img')[0];
                var canvas = document.createElement('canvas');

                $('#image-upload-input img').Jcrop({
                    bgColor: 'black',
                    bgOpacity: .6,
                    setSelect: [0, 0, 225, 225],
                    aspectRatio: 1,
                    onSelect: imgSelect,
                    onChange: imgSelect
                });

                function imgSelect(selection) {
                    canvas.width = canvas.height = 225;

                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, selection.x, selection.y, selection.w, selection.h, 0, 0, canvas.width, canvas.height);
                
                    imageUploadCode = canvas.toDataURL();
                }
            }
        }
    })(file);
    reader.readAsDataURL(file);
}

function onSubmitUploadImage(event) {
    if (imageUploadCode == null) {
        // $( "#image-upload-input" ).effect("shake");
        $("#image-upload-input").effect("shake", {times:3, distance: 5}, 500);
        return;
    }
    $.ajax({
        url: getProfileImageUploadAPI(),
        dataType: 'json',
        type: 'PUT',
        data: {image_code : imageUploadCode},
        success: function(data) {
            // close dialog on success
            $('#image-upload-modal').modal('hide');
            // reload data
            location.reload();
        }.bind(this),
        error: function(xhr, status, err) {
            console.error(getProfileImageUploadAPI(), status, err.toString());
        }.bind(this)
    });
}
</script>
{% endblock %}